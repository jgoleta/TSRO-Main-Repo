<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TSRO Gas Station</title>
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #85ff85, #b1ffa7);
      background-color: #e8f5e9;
      margin: 0;
      padding: 0;
    }

    nav {
      position: sticky;
      top: 0;
      background-color: #1b5e20;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      flex-wrap: wrap;
      z-index: 1000;
    }

    .site-title a {
      text-decoration: none;
      color: white;
    }

    .site-title h1 {
      font-size: 2rem;
      margin: 0;
    }

    .site-title p {
      margin: 5px 0 0;
      font-size: 0.9rem;
      color: #e0e0e0;
    }

    nav ul {
      display: flex;
      list-style: none;
      gap: 20px;
      padding: 0;
      margin: 0;
    }

    nav li a {
      text-decoration: none;
      color: white;
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-radius: 4px;
    }

    nav li a.fuel { color: #ffcdd2; }
    nav li a.products { color: #fff9c4; }
    nav li a.home { color: #e3f2fd; }

    nav li a.activelink {
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }

    nav li a i {
      margin-right: 8px;
    }

    .signout-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
      transition: background-color 0.2s;
      text-decoration: none;
    }

    .signout-btn:hover {
      background-color: #c82333;
    }

    .signout-btn i {
      margin-right: 4px;
    }

    .container {
      padding: 30px 40px;
      width: 100%;
      box-sizing: border-box;
    }

    .machine-section {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      margin-bottom: 40px;
      padding: 30px;
      width: 100%;
      box-sizing: border-box;
    }

    .machine-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 10px;
    }

    .machine-header h2 {
      margin: 0;
      font-size: 1.5rem;
      color: #2e7d32;
    }

    .fuel-table {
      margin-bottom: 30px;
      width: 100%;
    }

    .fuel-table h3 {
      margin-bottom: 10px;
      color: #1b5e20;
    }

    form.add-transaction-form {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .add-transaction-form label {
      font-weight: 600;
      color: #4e4e4e;
    }

    .add-transaction-form input[type="number"] {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      width: 160px;
    }

    .add-transaction-form button {
      background-color: #43a047;
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .add-transaction-form button:hover {
      background-color: #388e3c;
    }

    .transaction-table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-top: 20px;
      overflow: hidden;
      table-layout: fixed;
    }

    .transaction-table thead th {
      background-color: #a5d6a7;
      color: #1b5e20;
      font-size: 0.95rem;
      padding: 14px;
    }

    .transaction-table th, .transaction-table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }

    .transaction-table td {
      font-size: 0.95rem;
      word-wrap: break-word;
    }

    .transaction-table tfoot td {
      background-color: #f1f8e9;
      font-weight: bold;
    }

    .stock-input {
      width: 100%;
      max-width: 100px;
      padding: 6px 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    .remove-button {
      background-color: #d32f2f;
      color: white;
      border: none;
      padding: 6px 10px;
      font-size: 0.85rem;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .remove-button:hover {
      background-color: #c62828;
    }

    .min-max-button,
    .add-fuel-type-button {
      background-color: #43a047;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-top: 10px;
    }

    .min-max-button:hover,
    .add-fuel-type-button:hover {
      background-color: #2e7d32;
    }

    .add-button {
      display: flex;
      justify-content: center;
      margin: 30px 0;
    }

    .add-button button {
      background-color: #1b5e20;
      color: white;
      padding: 12px 22px;
      border: none;
      border-radius: 50%;
      font-size: 1.8rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .add-button button:hover {
      background-color: #145a1a;
    }

    .total-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 40px;
    }

    .summary-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      text-align: center;
      transition: transform 0.2s;
    }

    .summary-card:hover {
      transform: translateY(-5px);
    }

    .summary-card h3 {
      color: #1b5e20;
      margin: 0 0 10px 0;
      font-size: 1.1rem;
    }

    .summary-card .amount {
      font-size: 1.8rem;
      font-weight: bold;
      color: #2e7d32;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-header h2 {
      color: #1b5e20;
      margin: 0;
      font-size: 1.5rem;
    }

    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 40px;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
    }

    table th {
      background-color: #a5d6a7;
      color: #1b5e20;
      font-weight: 600;
      padding: 15px;
      text-align: left;
      font-size: 0.95rem;
    }

    table td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      font-size: 0.95rem;
    }

    table tbody tr:hover {
      background-color: #f5f5f5;
    }

    .remove-button {
      background-color: #d32f2f;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.2s;
    }

    .remove-button:hover {
      background-color: #b71c1c;
    }

    .empty-message {
      text-align: center;
      padding: 30px;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <nav>
    <div class="site-title">
      <a href="">
        <h1>TSRO Gas Station</h1>
      </a>
      <p>Automated fuel sale tracking and inventory system</p>
    </div>

    <ul>
      <li><a href="{% url 'webpage2' %}" class="home"><i class="fas fa-home"></i> Home</a></li>
      <li><a href="{% url 'webpage3' %}" class="activelink fuel"><i class="fas fa-gas-pump"></i> Fuel</a></li>
      <li><a href="{% url 'webpage5' %}" class="products"><i class="fas fa-box"></i> Products</a></li>
      <li><a href="{% url 'webpage6' %}" class="sales"><i class="fas fa-chart-line"></i> Sales</a></li>
      <li><a href="{% url 'webpage4' %}" class="history"><i class="fas fa-truck"></i> Delivery History</a></li>
    </ul>

    <a href="{% url 'webpage1' %}" class="signout-btn">
      <i class="fas fa-sign-out-alt"></i> Sign Out
    </a>
  </nav>

  <div class="container" id="machines-container"></div>

  <script>
    let machineCount = 0;
    let fuelTypeId = 0;
    const MAX_MACHINES = 3;
    const CLEARED_TRANSACTIONS_KEY = 'clearedFuelTransactions';

    // Function to initialize machines and load transactions
    function initializeMachines() {
      // Create 3 machines
      for (let i = 1; i <= MAX_MACHINES; i++) {
        addMachine();
      }

      try {
        // Check if transactions were cleared
        const clearedTransactions = localStorage.getItem(CLEARED_TRANSACTIONS_KEY);
        if (clearedTransactions === 'true') {
          const fuelSalesTbody = document.querySelector('#fuel-sales-table tbody');
          fuelSalesTbody.innerHTML = '<tr><td colspan="7" class="empty-message">No fuel sales recorded yet.</td></tr>';
          return;
        }

        // Load existing transactions
        const debugCount = parseInt('{{ debug_count }}');
        console.log("Debug count:", debugCount);
        
        const transactionsJson = '{{ transactions|safe }}';
        console.log("Raw JSON from server:", transactionsJson);
        
        if (transactionsJson && transactionsJson !== '[]') {
          const transactionsData = JSON.parse(transactionsJson);
          console.log("Parsed transactions data:", transactionsData);
          
          // Group transactions by machine and fuel type
          const groupedTransactions = {};
          transactionsData.forEach(transaction => {
            const machineKey = `machine_${transaction.machine_number}`;
            const fuelType = transaction.fuel_type.toLowerCase();
            
            if (!groupedTransactions[machineKey]) {
              groupedTransactions[machineKey] = {
                unleaded: [],
                diesel: []
              };
            }
            
            groupedTransactions[machineKey][fuelType].push(transaction);
          });
          
          console.log("Grouped transactions:", groupedTransactions);
          
          // Process each machine's transactions
          Object.entries(groupedTransactions).forEach(([machineKey, fuelTypes]) => {
            const machineId = machineKey.split('_')[1];
            console.log(`Processing machine ${machineId}`);
            
            // Process unleaded transactions
            if (fuelTypes.unleaded.length > 0) {
              const unleadedTable = document.getElementById(`table-${machineId}-Unleaded-1`);
              if (unleadedTable) {
                const tbody = unleadedTable.querySelector('tbody');
                fuelTypes.unleaded.forEach((transaction, index) => {
                  const row = tbody.insertRow();
                  row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>₱${parseFloat(transaction.amount).toFixed(2)}</td>
                    <td>${parseFloat(transaction.liters).toFixed(2)}</td>
                    <td><button class="remove-button" onclick="removeTransaction(event, ${machineId}, 'Unleaded-1', '${new Date(transaction.created_at).toLocaleString('en-US', {year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true})}')">Remove</button></td>
                    <td>${new Date(transaction.created_at).toLocaleString('en-US', {year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true})}</td>
                  `;
                });
                updateTotal(machineId, 'Unleaded-1');
              }
            }
            
            // Process diesel transactions
            if (fuelTypes.diesel.length > 0) {
              const dieselTable = document.getElementById(`table-${machineId}-Diesel-2`);
              if (dieselTable) {
                const tbody = dieselTable.querySelector('tbody');
                fuelTypes.diesel.forEach((transaction, index) => {
                  const row = tbody.insertRow();
                  row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>₱${parseFloat(transaction.amount).toFixed(2)}</td>
                    <td>${parseFloat(transaction.liters).toFixed(2)}</td>
                    <td><button class="remove-button" onclick="removeTransaction(event, ${machineId}, 'Diesel-2', '${new Date(transaction.created_at).toLocaleString('en-US', {year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true})}')">Remove</button></td>
                    <td>${new Date(transaction.created_at).toLocaleString('en-US', {year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true})}</td>
                  `;
                });
                updateTotal(machineId, 'Diesel-2');
              }
            }
          });
        }
      } catch (error) {
        console.error("Error processing transactions:", error);
        console.error("Error details:", error.message);
        console.error("Stack trace:", error.stack);
      }
    }

    function addMachine() {
      if (machineCount >= MAX_MACHINES) {
        return;
      }
      machineCount++;
      const container = document.getElementById("machines-container");
      const section = document.createElement("div");
      section.className = "machine-section";
      section.id = `machine-${machineCount}`;
      section.innerHTML = `
        <div class="machine-header">
          <h2><i class="fas fa-gas-pump"></i> Machine ${machineCount}</h2>
        </div>
        <div id="fuel-types-container-${machineCount}"></div>
      `;
      container.appendChild(section);
      addFuelType(machineCount, "Unleaded", true, "Unleaded-1");
      addFuelType(machineCount, "Diesel", true, "Diesel-2");
    }

    function addFuelType(machineId, name = null, isDefault = false, customSafeName = null) {
      if (!isDefault) {
        name = prompt("Enter fuel type name:");
        if (!name || name.trim() === "") return;
        name = name.trim();
      }
      const safeName = customSafeName || (name.replace(/\s+/g, "_") + "-" + (++fuelTypeId));
      const container = document.getElementById(`fuel-types-container-${machineId}`);
      const div = document.createElement("div");
      div.className = "fuel-table";
      div.innerHTML = `
        <h3>${name}</h3>
        <button class="min-max-button" onclick="toggleTable(${machineId}, '${safeName}')">Maximize</button>
        <form class="add-transaction-form" onsubmit="addTransaction(event, ${machineId}, '${safeName}')">
          <label for="price-${machineId}-${safeName}">Price per Liter (₱):</label>
          <input type="number" step="0.01" required id="price-${machineId}-${safeName}" value="60" />
          <label for="amount-${machineId}-${safeName}">Amount (₱):</label>
          <input type="number" step="0.01" required id="amount-${machineId}-${safeName}" />
          <button type="submit">Add</button>
        </form>
        <table id="table-${machineId}-${safeName}" class="transaction-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Amount (₱)</th>
              <th>Liters</th>
              <th>Remove</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {% if transactions_by_machine.machine_1 %}
              {% if safeName == 'Unleaded-1' %}
                {% for transaction in transactions_by_machine.machine_1.unleaded %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>₱{{ transaction.amount|floatformat:2 }}</td>
                  <td>{{ transaction.liters|floatformat:2 }}</td>
                  <td>
                    <button class="remove-button" onclick="removeTransaction(event, 1, 'Unleaded-1', '{{ transaction.created_at|date:"F d, Y, h:i:s A" }}')">Remove</button>
                  </td>
                  <td>{{ transaction.created_at|date:"F d, Y" }}</td>
                </tr>
                {% endfor %}
              {% elif safeName == 'Diesel-2' %}
                {% for transaction in transactions_by_machine.machine_1.diesel %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>₱{{ transaction.amount|floatformat:2 }}</td>
                  <td>{{ transaction.liters|floatformat:2 }}</td>
                  <td>
                    <button class="remove-button" onclick="removeTransaction(event, 1, 'Diesel-2', '{{ transaction.created_at|date:"F d, Y, h:i:s A" }}')">Remove</button>
                  </td>
                  <td>{{ transaction.created_at|date:"F d, Y" }}</td>
                </tr>
                {% endfor %}
              {% endif %}
            {% endif %}
          </tbody>
          <tfoot>
            <tr>
              <td colspan="2">Total Amount:</td>
              <td id="total-amount-${machineId}-${safeName}">₱0.00</td>
            </tr>
            <tr>
              <td colspan="2">Total Liters:</td>
              <td id="total-liters-${machineId}-${safeName}">0.00</td>
            </tr>
            <tr>
              <td colspan="2">Current Stock:</td>
              <td id="current-stock-${machineId}-${safeName}">1000.00</td>
            </tr>
            <tr>
              <td colspan="2">Add Stock:</td>
              <td>
                <div style="display: flex; gap: 10px; align-items: center;">
                  <input type="number" class="stock-input" id="add-stock-${machineId}-${safeName}" min="0" step="0.01" placeholder="Liters" />
                  <button onclick="addStock(${machineId}, '${safeName}')" class="min-max-button" style="padding: 6px 12px;">Add</button>
                </div>
              </td>
            </tr>
          </tfoot>
        </table>
      `;
      container.appendChild(div);
      
      // Initialize stock from localStorage or set default
      const stockKey = `stock_${machineId}_${safeName}`;
      const savedStock = localStorage.getItem(stockKey);
      if (savedStock) {
        const stock = parseFloat(savedStock);
        document.getElementById(`current-stock-${machineId}-${safeName}`).textContent = stock.toFixed(2);
        // Check for low stock on initialization
        if (stock <= 300) {
          const fuelType = document.querySelector(`#fuel-types-container-${machineId} .fuel-table:nth-child(${safeName.includes('Unleaded') ? 1 : 2}) h3`).textContent.trim();
          alert(`Low stock alert! ${fuelType} in Machine ${machineId} is running low (${stock.toFixed(2)} liters remaining)`);
        }
      }
    }

    function toggleTable(machineId, fuelKey) {
      const table = document.getElementById(`table-${machineId}-${fuelKey}`);
      const button = table.previousElementSibling.previousElementSibling;
      const rows = table.querySelector("tbody").rows;
      const isMaximized = button.innerText === 'Minimize';
      if (isMaximized) {
        for (let i = 0; i < rows.length; i++) {
          rows[i].style.display = i >= rows.length - 3 ? '' : 'none';
        }
        button.innerText = 'Maximize';
      } else {
        for (let row of rows) row.style.display = '';
        button.innerText = 'Minimize';
      }
    }

    function addStock(machineId, fuelKey) {
      const addStockInput = document.getElementById(`add-stock-${machineId}-${fuelKey}`);
      const currentStockElement = document.getElementById(`current-stock-${machineId}-${fuelKey}`);
      const addAmount = parseFloat(addStockInput.value);
      
      if (isNaN(addAmount) || addAmount <= 0) {
        alert('Please enter a valid amount to add');
        return;
      }

      const currentStock = parseFloat(currentStockElement.textContent);
      const newStock = currentStock + addAmount;
      
      // Check if new stock would exceed maximum capacity
      if (newStock > 1000) {
        alert('Cannot add stock. Maximum capacity is 1000 liters.');
        return;
      }
      
      // Update display
      currentStockElement.textContent = newStock.toFixed(2);
      
      // Save to localStorage
      const stockKey = `stock_${machineId}_${fuelKey}`;
      localStorage.setItem(stockKey, newStock.toString());
      
      // Clear input
      addStockInput.value = '';
    }

    function updateStockAfterTransaction(machineId, fuelKey, litersChange) {
      const currentStockElement = document.getElementById(`current-stock-${machineId}-${fuelKey}`);
      let currentStock = parseFloat(currentStockElement.textContent);
      
      if (!isNaN(currentStock)) {
        currentStock -= litersChange;
        currentStockElement.textContent = currentStock.toFixed(2);
        
        // Save to localStorage
        const stockKey = `stock_${machineId}_${fuelKey}`;
        localStorage.setItem(stockKey, currentStock.toString());

        // Check for low stock alert
        if (currentStock <= 300) {
          const fuelType = document.querySelector(`#fuel-types-container-${machineId} .fuel-table:nth-child(${fuelKey.includes('Unleaded') ? 1 : 2}) h3`).textContent.trim();
          alert(`Low stock alert! ${fuelType} in Machine ${machineId} is running low (${currentStock.toFixed(2)} liters remaining)`);
        }
      }
    }

    function addTransaction(event, machineId, fuelKey) {
      event.preventDefault();
      const amountInput = document.getElementById(`amount-${machineId}-${fuelKey}`);
      const priceInput = document.getElementById(`price-${machineId}-${fuelKey}`);
      const amount = parseFloat(amountInput.value);
      const price = parseFloat(priceInput.value);
      if (isNaN(amount) || amount <= 0 || isNaN(price) || price <= 0) return;

      // Check if there's enough stock
      const currentStockElement = document.getElementById(`current-stock-${machineId}-${fuelKey}`);
      const currentStock = parseFloat(currentStockElement.textContent);
      const liters = amount / price;
      
      if (currentStock < liters) {
        const fuelType = document.querySelector(`#fuel-types-container-${machineId} .fuel-table:nth-child(${fuelKey.includes('Unleaded') ? 1 : 2}) h3`).textContent.trim();
        alert(`Invalid transaction! Not enough ${fuelType} stock available.\nRequested: ${liters.toFixed(2)} liters\nAvailable: ${currentStock.toFixed(2)} liters`);
        return;
      }

      const table = document.getElementById(`table-${machineId}-${fuelKey}`);
      const tbody = table.querySelector("tbody");
      const newRow = tbody.insertRow();
      
      // Different date format based on machine number
      let date;
      if (machineId === 1) {
        date = new Date().toLocaleString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: 'numeric',
          minute: 'numeric',
          second: 'numeric',
          hour12: true
        });
      } else {
        date = new Date().toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      }
      
      newRow.innerHTML = `
        <td>${tbody.rows.length}</td>
        <td>₱${amount.toFixed(2)}</td>
        <td>${liters.toFixed(2)}</td>
        <td><button class="remove-button" onclick="removeTransaction(event, ${machineId}, '${fuelKey}', '${date}')">Remove</button></td>
        <td>${date}</td>
      `;
      updateTotal(machineId, fuelKey);
      toggleTable(machineId, fuelKey);
      updateStockAfterTransaction(machineId, fuelKey, liters);
      amountInput.value = '';

      // Save to database and update Fuel Sales table
      const fuelType = document.querySelector(`#fuel-types-container-${machineId} .fuel-table:nth-child(${fuelKey.includes('Unleaded') ? 1 : 2}) h3`).textContent.trim();
      fetch('{% url "save_fuel_transaction" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          machine_number: machineId,
          fuel_type: fuelType,
          amount: amount,
          liters: liters,
          price_per_liter: price,
          created_at: date
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Clear the cleared state when adding a new transaction
          localStorage.removeItem(CLEARED_TRANSACTIONS_KEY);
          
          // Add the new transaction to the Fuel Sales table
          const fuelSalesTable = document.getElementById('fuel-sales-table');
          const fuelSalesTbody = fuelSalesTable.querySelector('tbody');
          // Remove the empty message if it exists
          if (fuelSalesTbody.querySelector('.empty-message')) {
            fuelSalesTbody.innerHTML = '';
          }
          const newFuelSalesRow = fuelSalesTbody.insertRow(0); // Insert at the top
          newFuelSalesRow.innerHTML = `
            <td>${machineId}</td>
            <td>${fuelType}</td>
            <td>₱${amount.toFixed(2)}</td>
            <td>${liters.toFixed(3)}</td>
            <td>₱${price.toFixed(2)}</td>
            <td>${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
            <td>
              <button onclick="removeFromDisplay(this)" class="remove-button">Remove</button>
            </td>
          `;
        } else {
          console.error('Error saving transaction:', data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }

    function removeTransaction(event, machineId, fuelKey, date) {
      const row = event.target.closest("tr");
      const amount = parseFloat(row.cells[1].textContent.replace('₱', ''));
      const liters = parseFloat(row.cells[2].textContent);
      
      // Remove the row from the table
      row.remove();
      
      // Update totals and stock
      updateTotal(machineId, fuelKey);
      updateStockAfterTransaction(machineId, fuelKey, -liters);
    }

    function updateTotal(machineId, fuelKey) {
      const table = document.getElementById(`table-${machineId}-${fuelKey}`);
      const rows = table.querySelector("tbody").rows;
      let totalAmount = 0, totalLiters = 0;
      for (let row of rows) {
        const amount = parseFloat(row.cells[1].textContent.replace('₱', ''));
        const liters = parseFloat(row.cells[2].textContent);
        totalAmount += amount;
        totalLiters += liters;
      }
      document.getElementById(`total-amount-${machineId}-${fuelKey}`).textContent = `₱${totalAmount.toFixed(2)}`;
      document.getElementById(`total-liters-${machineId}-${fuelKey}`).textContent = totalLiters.toFixed(2);
    }

    function clearFuelTransactions() {
      const tbody = document.querySelector('#fuel-sales-table tbody');
      tbody.innerHTML = '<tr><td colspan="7" class="empty-message">No fuel sales recorded yet.</td></tr>';
      // Store the cleared state in localStorage
      localStorage.setItem(CLEARED_TRANSACTIONS_KEY, 'true');
    }

    function removeFromDisplay(button) {
      const row = button.closest('tr');
      row.remove();
      
      // If no transactions left, show the empty message
      const tbody = document.querySelector('#fuel-sales-table tbody');
      if (tbody.rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-message">No fuel sales recorded yet.</td></tr>';
        localStorage.setItem(CLEARED_TRANSACTIONS_KEY, 'true');
      }
    }

    // Initialize machines when the page loads
    document.addEventListener('DOMContentLoaded', initializeMachines);
  </script>

  <div class="container">
    <div class="table-container">
      <div class="section-header">
        <h2><i class="fas fa-gas-pump"></i> Fuel Transactions</h2>
        <button onclick="clearFuelTransactions()" class="remove-button" style="background-color: #d32f2f; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
          <i class="fas fa-trash"></i> Clear Transactions
        </button>
      </div>
      <table id="fuel-sales-table">
        <thead>
          <tr>
            <th>Petroleum ID</th>
            <th>Machine Number</th>
            <th>Fuel Type</th>
            <th>Amount (₱)</th>
            <th>Liters</th>
            <th>Price per Liter (₱)</th>
            <th>Created At</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for transaction in fuel_transactions %}
          <tr>
            <td>{% if transaction.fuel_type == 'Unleaded' %}1{% else %}2{% endif %}</td>
            <td>{{ transaction.machine_number }}</td>
            <td>{{ transaction.fuel_type }}</td>
            <td>₱{{ transaction.amount|floatformat:2 }}</td>
            <td>{{ transaction.liters|floatformat:3 }}</td>
            <td>₱{{ transaction.price_per_liter|floatformat:2 }}</td>
            <td>{{ transaction.created_at|date:"F d, Y" }}</td>
            <td>
              <button onclick="removeFromDisplay(this)" class="remove-button">Remove</button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="empty-message">No fuel sales recorded yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</body>
</html>
